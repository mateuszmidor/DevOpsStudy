# Go wasm plugin for Envoy to be run in Istio

This hello-world golang wasm envoy plugin simply prints out incoming request body to envoy logs.

## Overview

- the plugin binary is built and uploaded to AWS S3 with `build_upload.sh` (you need to update the S3 location to somewhere where you have write permissions)
  - S3 is used as the binary needs to be publicly accessible for downloading by Istio Operator, otherwise it needs to reside inside istio-proxy container somehow
  - S3 URL needs to be updated in `build_upload.sh` and `wasm-plugin.yaml`
- the plugin is deployed in kubernetes cluster with `wasm-plugin.yaml` and applied to all pods labeled as `project=free5gc`

To see Envoy proxy logs in Istio, need to first change logging level from warn to info.

## Build, upload, run and see the logs

```sh
./build_upload.sh
kubectl apply -f wasm-plugin.yaml
istioctl proxy-config log --level info --selector nf=amf # logging level is per-POD

# (here deploy UEARNSIM to trigger signalling towards AMF)

kubectl logs <amf_pod_id> -c istio-proxy | grep wasm
```

Logs generated by deploying UERANSIM:

```log
kubectl logs free5gc-free5gc-amf-amf-599758d978-lxqz9 -c istio-proxy | grep wasm

2022-11-15T10:25:20.167677Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 106, endOfStream: true
2022-11-15T10:25:20.167795Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [106]: {"supiOrSuci":"suci-0-208-93-0000-0-0-0000000003","servingNetworkName":"5G:mnc093.mcc208.3gppnetwork.org"}
2022-11-15T10:25:20.446636Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 212, endOfStream: true
2022-11-15T10:25:20.446659Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [212]: {"supiOrSuci":"suci-0-208-93-0000-0-0-0000000003","servingNetworkName":"5G:mnc093.mcc208.3gppnetwork.org","resynchronizationInfo":{"rand":"c43ae31553f793059ca6b4ba372d4b56","auts":"72ad6be94c589d4ec119348427c1"}}
2022-11-15T10:25:20.458558Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 46, endOfStream: true
2022-11-15T10:25:20.458578Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [46]: {"resStar":"c6a0c70a66748b0aca69a42aa99d51fb"}
2022-11-15T10:25:20.580801Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 218, endOfStream: true
2022-11-15T10:25:20.580820Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [218]: {"amfInstanceId":"3781c3cd-2227-453c-aae3-658361b467f1","imsVoPs":"HOMOGENEOUS_NON_SUPPORT","deregCallbackUri":"","initialRegistrationInd":true,"guami":{"plmnId":{"mcc":"208","mnc":"93"},"amfId":"cafe00"},"ratType":""}
2022-11-15T10:25:20.675712Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 141, endOfStream: true
2022-11-15T10:25:20.675735Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [141]: {"nfInstanceId":"3781c3cd-2227-453c-aae3-658361b467f1","callbackReference":"","monitoredResourceUris":null,"plmnId":{"mcc":"208","mnc":"93"}}
2022-11-15T10:25:20.712417Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 298, endOfStream: true
2022-11-15T10:25:20.712492Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [298]: {"notificationUri":"http://amf-namf:80/namf-callback/v1/am-policy/","supi":"imsi-208930000000003","gpsi":"msisdn-0900000000","accessType":"3GPP_ACCESS","pei":"imeisv-4370816125816151","servingPlmn":{"mnc":"93","mcc":"208"},"guami":{"plmnId":{"mcc":"208","mnc":"93"},"amfId":"cafe00"},"suppFeat":""}
2022-11-15T10:25:20.769631Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 131, endOfStream: false
2022-11-15T10:25:20.769653Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 131, endOfStream: true
2022-11-15T10:25:20.769659Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [131]: {"amfStatusUri":"http://pcf-npcf:80/npcf-callback/v1/amfstatus","guamiList":[{"plmnId":{"mcc":"208","mnc":"93"},"amfId":"cafe00"}]}
2022-11-15T10:25:21.109254Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: OnHttpRequestBody - BodySize: 785, endOfStream: true
2022-11-15T10:25:21.109283Z     info    envoy wasm      wasm log 5gc.my-wasm-plugin-1: Request body [785]: --05ee1e5f185973a429c446bfc6478b2348cad82c30060172bde5f1ca3dd0
```